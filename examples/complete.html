<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.10/css/all.css" integrity="sha384-+d0P83n9kaQMCwj8F4RJB66tzIwOKmrdb46+porD/OvrJ+37WqIM7UoBtwHO6Nlg" crossorigin="anonymous">
  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" crossorigin="anonymous">
  <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js" integrity="sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js" integrity="sha384-uefMccjFJAIv6A+rW+L4AHf99KvxDjWSu1z9VI8SKNVmz4sk7buKt/6v9KI65qnm" crossorigin="anonymous"></script>
  <!-- RxJS -->
  <script src="https://unpkg.com/rxjs@5.5.10/bundles/Rx.min.js"></script>
  <title>QNH BB Workshop</title>
</head>

<body>
  <div class="container">
	  <h2 class="mt-5 mb-3">Github search</h2>
	  <form class="form" onSubmit="return false">
		<div class="form-row">
		  <div class="form-group col-md-3"><input id="username" type="text" class="form-control" placeholder="Username"></div>
		  <div class="form-group col-md-3"><input id="password" type="password" class="form-control" placeholder="Password"></div>
		</div>
		<div class="form-group w-50">
		  <div class="input-group">
			<input id="search" type="text" class="form-control" placeholder="Start typing..." aria-describedby="addon">
			<div class="input-group-append">
			  <span class="input-group-text" id="addon"><i class="fa fa-search"></i></span>
			</div>
		  </div>
		</div>
	  </form>
	  
	  <div class="table-responsive">
		<table class="table">
		  <thead><tr><th scope="col">Name</th><th scope="col">Avatar</th><th scope="col">Url</th></tr></thead>
		  <tbody></tbody>
		</table>
	  </div>
	</div>

	<script type="text/javascript">
	  var click$ = Rx.Observable.fromEvent($('.input-group-text'), 'click');
	  
	  var username$ = Rx.Observable.fromEvent($('#username'), 'input').map(event => event.target.value);
	  var password$ = Rx.Observable.fromEvent($('#password'), 'input').map(event => event.target.value);
	  var input$ = Rx.Observable.fromEvent($('#search'), 'input');
	  var value$ = input$.map(event => event.target.value);
	  var enter$ = Rx.Observable.fromEvent($('#search'), 'keyup').filter(e => e.keyCode == 13);
	  
	  var trigger$ = Rx.Observable.merge(enter$, click$);
	  var userSearch$ = trigger$.withLatestFrom(value$).map(values => values[1]).distinctUntilChanged().filter(value => value !== '');
	  var search$ = userSearch$
			.withLatestFrom(username$, password$)
			.switchMap(values => {
				return get(
					'https://api.github.com/search/users?per_page=100&q=' + encodeURI(values[0]),
					{ 'Authorization': 'Basic ' + btoa(values[1] + ':' + values[2]) }
				);
			});

	  search$.subscribe(value => {
			$('table > tbody > tr').remove();
			value.items.forEach((item) => addRow(item));
		});

		function get(url, headers) {
			return Rx.Observable.create(observer => {
				const req = new XMLHttpRequest();
				req.open('GET', url);
				for (const headerName in headers) {
					if (headers.hasOwnProperty(headerName)) {
						req.setRequestHeader(headerName, headers[headerName])
					}
				}
				req.onload = () => {
					if (req.status === 200) {
						observer.next(JSON.parse(req.response));
						observer.complete();
					} else {
						observer.error(new Error(req.statusText));
					}
				}

				req.onerror = () => {
					observer.error(new Error('An error occured'));
				};

				req.send();
				return () => req.abort();
			});
		}

	  function addRow(user) {
			var newRow = $('<tr>');
			newRow.append(createCell(user.login));
			newRow.append(createCell('<img class="img-thumbnail" src="'+ user.avatar_url + '">'));
			newRow.append(createCell('<a href="' + user.url + '">Link<a>'));
			$('table').append(newRow);
	  }
	  
	  function createCell(data) {
			return '<td>' + data + '</td>';
	  }
	</script>
</body>
</html>